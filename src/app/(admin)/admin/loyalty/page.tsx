'use client';

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { 
  Star, 
  Users, 
  Gift, 
  Plus, 
  Minus,\n  Search,\n  RefreshCw,\n  TrendingUp,\n  AlertCircle\n} from 'lucide-react';\nimport { loyaltyAPI, LoyaltyAccount } from '@/services/loyaltyApi';\nimport { toast } from 'sonner';\n\nexport default function LoyaltyManagementPage() {\n  const [loyaltyAccounts, setLoyaltyAccounts] = useState<LoyaltyAccount[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedAccount, setSelectedAccount] = useState<LoyaltyAccount | null>(null);\n  const [addPointsOpen, setAddPointsOpen] = useState(false);\n  const [redeemPointsOpen, setRedeemPointsOpen] = useState(false);\n  const [pointsAmount, setPointsAmount] = useState('');\n  const [operationLoading, setOperationLoading] = useState(false);\n\n  useEffect(() => {\n    loadLoyaltyAccounts();\n  }, []);\n\n  const loadLoyaltyAccounts = async () => {\n    try {\n      setLoading(true);\n      const accounts = await loyaltyAPI.getAllLoyaltyAccounts();\n      setLoyaltyAccounts(accounts);\n    } catch (error) {\n      console.error('Error loading loyalty accounts:', error);\n      toast.error('Không thể tải danh sách tài khoản loyalty');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleAddPoints = async () => {\n    if (!selectedAccount || !pointsAmount || parseInt(pointsAmount) <= 0) {\n      toast.error('Vui lòng nhập số điểm hợp lệ');\n      return;\n    }\n\n    try {\n      setOperationLoading(true);\n      await loyaltyAPI.addPointsToUser(selectedAccount.user._id, { \n        points: parseInt(pointsAmount) \n      });\n      \n      toast.success(\n        `Đã thêm ${formatNumber(parseInt(pointsAmount))} điểm cho ${selectedAccount.user.name}`\n      );\n      \n      setAddPointsOpen(false);\n      setPointsAmount('');\n      setSelectedAccount(null);\n      loadLoyaltyAccounts();\n    } catch (error: any) {\n      console.error('Error adding points:', error);\n      toast.error(error.response?.data?.message || 'Có lỗi xảy ra khi thêm điểm');\n    } finally {\n      setOperationLoading(false);\n    }\n  };\n\n  const handleRedeemPoints = async () => {\n    if (!selectedAccount || !pointsAmount || parseInt(pointsAmount) <= 0) {\n      toast.error('Vui lòng nhập số điểm hợp lệ');\n      return;\n    }\n\n    if (parseInt(pointsAmount) > selectedAccount.points) {\n      toast.error('Số điểm quy đổi vượt quá số điểm hiện có');\n      return;\n    }\n\n    try {\n      setOperationLoading(true);\n      await loyaltyAPI.redeemUserPoints(selectedAccount.user._id, { \n        points: parseInt(pointsAmount) \n      });\n      \n      toast.success(\n        `Đã quy đổi ${formatNumber(parseInt(pointsAmount))} điểm cho ${selectedAccount.user.name}`\n      );\n      \n      setRedeemPointsOpen(false);\n      setPointsAmount('');\n      setSelectedAccount(null);\n      loadLoyaltyAccounts();\n    } catch (error: any) {\n      console.error('Error redeeming points:', error);\n      toast.error(error.response?.data?.message || 'Có lỗi xảy ra khi quy đổi điểm');\n    } finally {\n      setOperationLoading(false);\n    }\n  };\n\n  const formatNumber = (num: number) => {\n    return new Intl.NumberFormat('vi-VN').format(num);\n  };\n\n  const filteredAccounts = loyaltyAccounts.filter(account =>\n    account.user.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    account.user.email.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const totalPoints = loyaltyAccounts.reduce((sum, account) => sum + account.points, 0);\n  const totalUsers = loyaltyAccounts.length;\n  const averagePoints = totalUsers > 0 ? Math.floor(totalPoints / totalUsers) : 0;\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Quản lý Loyalty</h1>\n        <p className=\"text-gray-600\">\n          Quản lý hệ thống điểm thưởng khách hàng\n        </p>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Tổng thành viên</p>\n                <p className=\"text-2xl font-bold\">{formatNumber(totalUsers)}</p>\n              </div>\n              <div className=\"p-3 bg-blue-100 rounded-full\">\n                <Users className=\"h-6 w-6 text-blue-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Tổng điểm</p>\n                <p className=\"text-2xl font-bold\">{formatNumber(totalPoints)}</p>\n              </div>\n              <div className=\"p-3 bg-yellow-100 rounded-full\">\n                <Star className=\"h-6 w-6 text-yellow-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Điểm TB/người</p>\n                <p className=\"text-2xl font-bold\">{formatNumber(averagePoints)}</p>\n              </div>\n              <div className=\"p-3 bg-green-100 rounded-full\">\n                <TrendingUp className=\"h-6 w-6 text-green-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-gray-600\">Giá trị quy đổi</p>\n                <p className=\"text-2xl font-bold\">\n                  {formatNumber(loyaltyAPI.calculateDiscountFromPoints(totalPoints))}đ\n                </p>\n              </div>\n              <div className=\"p-3 bg-purple-100 rounded-full\">\n                <Gift className=\"h-6 w-6 text-purple-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Search and Actions */}\n      <Card className=\"mb-6\">\n        <CardHeader>\n          <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5\" />\n              Danh sách tài khoản Loyalty\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={loadLoyaltyAccounts}\n                disabled={loading}\n              >\n                <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\n                Làm mới\n              </Button>\n            </div>\n          </div>\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4\" />\n            <Input\n              placeholder=\"Tìm kiếm theo tên hoặc email...\"\n              className=\"pl-10\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n            />\n          </div>\n        </CardHeader>\n        <CardContent>\n          {loading ? (\n            <div className=\"text-center py-8\">\n              <RefreshCw className=\"h-8 w-8 animate-spin mx-auto mb-4 text-gray-400\" />\n              <p className=\"text-gray-500\">Đang tải dữ liệu...</p>\n            </div>\n          ) : filteredAccounts.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <AlertCircle className=\"h-8 w-8 mx-auto mb-4 text-gray-400\" />\n              <p className=\"text-gray-500\">\n                {searchTerm ? 'Không tìm thấy tài khoản nào' : 'Chưa có tài khoản loyalty nào'}\n              </p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Khách hàng</TableHead>\n                  <TableHead>Email</TableHead>\n                  <TableHead className=\"text-center\">Điểm hiện tại</TableHead>\n                  <TableHead className=\"text-center\">Giá trị</TableHead>\n                  <TableHead className=\"text-center\">Ngày tham gia</TableHead>\n                  <TableHead className=\"text-center\">Thao tác</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredAccounts.map((account) => (\n                  <TableRow key={account._id}>\n                    <TableCell className=\"font-medium\">\n                      {account.user.name}\n                    </TableCell>\n                    <TableCell>{account.user.email}</TableCell>\n                    <TableCell className=\"text-center\">\n                      <Badge variant=\"outline\" className=\"border-yellow-400 text-yellow-700\">\n                        <Star className=\"h-3 w-3 mr-1\" />\n                        {formatNumber(account.points)}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-center font-medium\">\n                      {formatNumber(loyaltyAPI.calculateDiscountFromPoints(account.points))}đ\n                    </TableCell>\n                    <TableCell className=\"text-center\">\n                      {new Date(account.createdAt).toLocaleDateString('vi-VN')}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center justify-center gap-2\">\n                        <Dialog open={addPointsOpen && selectedAccount?._id === account._id} onOpenChange={(open) => {\n                          setAddPointsOpen(open);\n                          if (open) {\n                            setSelectedAccount(account);\n                            setPointsAmount('');\n                          } else {\n                            setSelectedAccount(null);\n                          }\n                        }}>\n                          <DialogTrigger asChild>\n                            <Button size=\"sm\" variant=\"outline\">\n                              <Plus className=\"h-3 w-3 mr-1\" />\n                              Thêm\n                            </Button>\n                          </DialogTrigger>\n                          <DialogContent>\n                            <DialogHeader>\n                              <DialogTitle>Thêm điểm cho {account.user.name}</DialogTitle>\n                              <DialogDescription>\n                                Thêm điểm thưởng vào tài khoản khách hàng\n                              </DialogDescription>\n                            </DialogHeader>\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label htmlFor=\"addPoints\">Số điểm muốn thêm</Label>\n                                <Input\n                                  id=\"addPoints\"\n                                  type=\"number\"\n                                  placeholder=\"Nhập số điểm\"\n                                  value={pointsAmount}\n                                  onChange={(e) => setPointsAmount(e.target.value)}\n                                  min=\"1\"\n                                />\n                              </div>\n                              {pointsAmount && parseInt(pointsAmount) > 0 && (\n                                <div className=\"text-sm text-gray-600\">\n                                  Tương đương: {formatNumber(loyaltyAPI.calculateDiscountFromPoints(parseInt(pointsAmount)))}đ\n                                </div>\n                              )}\n                            </div>\n                            <DialogFooter>\n                              <Button variant=\"outline\" onClick={() => setAddPointsOpen(false)}>\n                                Hủy\n                              </Button>\n                              <Button onClick={handleAddPoints} disabled={operationLoading}>\n                                {operationLoading ? 'Đang xử lý...' : 'Thêm điểm'}\n                              </Button>\n                            </DialogFooter>\n                          </DialogContent>\n                        </Dialog>\n\n                        <Dialog open={redeemPointsOpen && selectedAccount?._id === account._id} onOpenChange={(open) => {\n                          setRedeemPointsOpen(open);\n                          if (open) {\n                            setSelectedAccount(account);\n                            setPointsAmount('');\n                          } else {\n                            setSelectedAccount(null);\n                          }\n                        }}>\n                          <DialogTrigger asChild>\n                            <Button \n                              size=\"sm\" \n                              variant=\"outline\" \n                              disabled={account.points === 0}\n                            >\n                              <Minus className=\"h-3 w-3 mr-1\" />\n                              Quy đổi\n                            </Button>\n                          </DialogTrigger>\n                          <DialogContent>\n                            <DialogHeader>\n                              <DialogTitle>Quy đổi điểm cho {account.user.name}</DialogTitle>\n                              <DialogDescription>\n                                Quy đổi điểm thưởng từ tài khoản khách hàng\n                                <br />\n                                <span className=\"text-yellow-600 font-medium\">\n                                  Điểm hiện tại: {formatNumber(account.points)}\n                                </span>\n                              </DialogDescription>\n                            </DialogHeader>\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label htmlFor=\"redeemPoints\">Số điểm muốn quy đổi</Label>\n                                <Input\n                                  id=\"redeemPoints\"\n                                  type=\"number\"\n                                  placeholder=\"Nhập số điểm\"\n                                  value={pointsAmount}\n                                  onChange={(e) => setPointsAmount(e.target.value)}\n                                  min=\"1\"\n                                  max={account.points}\n                                />\n                              </div>\n                              {pointsAmount && parseInt(pointsAmount) > 0 && (\n                                <div className=\"text-sm text-gray-600\">\n                                  Giá trị: {formatNumber(loyaltyAPI.calculateDiscountFromPoints(parseInt(pointsAmount)))}đ\n                                </div>\n                              )}\n                            </div>\n                            <DialogFooter>\n                              <Button variant=\"outline\" onClick={() => setRedeemPointsOpen(false)}>\n                                Hủy\n                              </Button>\n                              <Button onClick={handleRedeemPoints} disabled={operationLoading}>\n                                {operationLoading ? 'Đang xử lý...' : 'Quy đổi'}\n                              </Button>\n                            </DialogFooter>\n                          </DialogContent>\n                        </Dialog>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}
